### Vite를 이해 부족 
Vite는 정말 프로트 개발을 위한 프로그램인데
node를 가져다 쓸려니깐 문제가 발생함
node 서버를 가져다 쓰는 아이인데 
브라우저만 그려주는 아이기 때문에서 서버를 몰름 
그래서 문제가 남 아오
그래서vite는 서버와 연결하는 중간다리 역할이 필요하다
그래서 node 서버를 만들었다




# 1) Vite를 이해 부족 

* **브라우저(프론트, Vite 앱)**: 화면만 보여주는 아이.
* **서버(Express)**: 보안정보를 가지고 있다가 서버에 전달.

---

# 2) 왜 서버 연동이 필요할까

스포티파이 토큰을 받으려면 **비밀키(client secret)** 가 필요한데 근데 vite 브라우저만 취급한다 그래서 문제 발생

* 이 **비밀키는 절대 브라우저에 보여주면 안 돼**(도난 위험!).
* 그래서 vite는 서버라는 녀석이 중간 다리 역할을 해서 스포티파이 토큰을 가져와야 한다.

---

# 3) 흐름

```
[브라우저]  --(POST /api/spotify/token)-->  [내 서버]  --(비밀열쇠로 요청)-->  [스포티파이]
      ←-------------------- 토큰 JSON --------------------←
```

* 브라우저: `/api/spotify/token` 으로 **POST** 요청
* 내 서버: 비밀열쇠로 스포티파이에 요청해서 **토큰** 받음
* 내 서버 → 브라우저: 토큰을 돌려줌
* 브라우저: 그 토큰으로 **[https://api.spotify.com/v1/](https://api.spotify.com/v1/)...** 에 음악 정보 요청

---

# 4) 네가 겪었던 에러



👉 **프론트(React, Vite)** 에서 직접 Spotify에 요청하지 않고,
**내 서버(Express)** 를 거쳐서 안전하게 **토큰 → 데이터**를 받는 구조 만들기.

---

# 🧩 1. 구조부터 이해

### 🧠 구조

| 이름            | 하는 일          | 예시                           |
| ------------- | ------------- | ---------------------------- |
| 🎨 프론트(브라우저)  | 화면 보여주기       | React, Vite                  |
| 🧱 내 서버       | 중간 전달자 (심부름꾼) | Express                      |
| 🎵 Spotify 서버 | 음악 정보 저장소     | `https://api.spotify.com/v1` |

---

## ⚙️ 작동 흐름 (그림처럼 상상해보자)

```
[프론트]  →  [내 서버]  →  [Spotify 서버]
    ↑             ↓
   (화면)       (토큰 전달)
```

1️⃣ 프론트: “서버야, 토큰 좀 받아와줘!” (`POST /api/spotify/token`)
2️⃣ 서버: “스포티파이야, 나 이 ID랑 비밀로 토큰 좀 줘!”
3️⃣ Spotify: “자, 여기 토큰!”
4️⃣ 서버: 그 토큰을 프론트에게 전달
5️⃣ 프론트: 그 토큰으로 새 앨범 목록 요청! (`/browse/new-releases`)

---

# 🛠️ 2. 실제로 네가 한 일 (단계별 요약)

### ✅ (1) 서버에서 Spotify 토큰 받기

```ts
app.post("/api/spotify/token", async (_req, res) => {
  const id = process.env.SPOTIFY_CLIENT_ID;
  const secret = process.env.SPOTIFY_CLIENT_SECRET;
  const basic = Buffer.from(`${id}:${secret}`).toString("base64");
  const body = new URLSearchParams({ grant_type: "client_credentials" });

  const r = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: {
      Authorization: `Basic ${basic}`,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body,
  });

  const text = await r.text();
  res.type("application/json").send(text);
});
```

👉 이 코드는 “Spotify야, 내 ID랑 비밀줄게! 토큰 하나 줘!” 라고 요청하는 코드

---

### ✅ (2) `.env` 로 비밀(ID/SECRET) 숨기기

```bash
SPOTIFY_CLIENT_ID=abcd1234
SPOTIFY_CLIENT_SECRET=xyz9876
```

이건 **내 컴퓨터 안에서만** 읽히는 파일이에요.
서버 코드에서 이렇게 가져왔죠 👇

```ts
dotenv.config({ path: path.join(process.cwd(), ".env") });
```

즉, **비밀은 코드에 직접 쓰지 않고 `.env`에 숨김!**

---

### ✅ (3) 프론트에서 내 서버로 요청

```ts
export const getClientCredentialToken = async () => {
  const res = await axios.post("http://localhost:4000/api/spotify/token");
  return res.data;
};
```

👉 브라우저는 스포티파이에 직접 가지 않고,
내 서버에게 “토큰 좀 받아와줘”라고 부탁한 거예요.

---

### ✅ (4) 받은 토큰으로 Spotify 데이터 요청

```ts
export const getNewReleases = async (token: string) => {
  const res = await axios.get(
    "https://api.spotify.com/v1/browse/new-releases?limit=6",
    { headers: { Authorization: `Bearer ${token}` } }
  );
  return res.data;
};
```

👉 이제 Spotify API에 직접 접근할 수 있어요.
다만 **토큰이 준비된 다음에만** 요청해야 해요.

React Query에서는 이렇게 👇

```ts
const token = useClientCredentialToken();
useQuery({
  queryKey: ["new-releases", token],
  queryFn: () => getNewReleases(token!),
  enabled: !!token, // token이 있을 때만 실행
});
```

---

# 🧠 3. 네가 겪었던 오류 + 원인 정리

| 오류                | 원인                                                           | 해결                                              |
| ----------------- | ------------------------------------------------------------ | ----------------------------------------------- |
| ❌ 404             | 브라우저 주소창은 **GET** 요청이라, **POST만 받는 서버에 못 들어감**               | `axios.post("/api/spotify/token")` 으로 요청해야 함    |
| ❌ 500             | `.env` 파일 못 읽거나 값이 비어 있음                                     | `dotenv.config({ path: ... })` 로 경로 지정 + 서버 재시작 |
| ❌ HTML 반환         | Spotify 주소(`https://api.spotify.com/v1`)가 아니라 프론트(5173)로 요청감 | `SPOTIFY_BASE_URL`을 절대주소로 설정                    |
| ❌ undefined token | `useQuery`가 토큰 준비 전 실행                                       | `enabled: !!token` 추가                           |

---

# 🔒 4. 핵심 원리 (초등학생 버전)

| 핵심 문장                 | 의미                                           |
| --------------------- | -------------------------------------------- |
| 🧱 **비밀은 서버만**        | Client Secret은 브라우저에 절대 공개하면 안 돼             |
| 🚪 **POST로 문을 두드려라**  | 주소창은 GET이라 막힘 → axios.post() 써야 함            |
| 🧭 **정확한 주소로 가라**     | `https://api.spotify.com/v1` 이 아니면 엉뚱한 곳으로 감 |
| 🔑 **토큰은 허락증이다**      | Spotify에서 받은 토큰이 있어야 데이터 열람 가능               |
| ⏳ **토큰이 생긴 후에만 요청하라** | 없을 땐 기다리고, 있으면 데이터 요청                        |

---

# ✅ 5. 지금 결과 해석

```
[spotify][status] 200
[spotify][text] {"access_token":"BQDPf3...","token_type":"Bearer","expires_in":3600}
```

이제 그 `access_token`을 써서 다른 Spotify API(`/browse/new-releases`, `/tracks`, `/artists` 등)

---

# ✨ 요약 그림

```
┌────────────┐       ┌────────────┐       ┌──────────────────────┐
│ 프론트(React) │────▶│ 내 서버(Express) │────▶│ Spotify 서버(API) │
│ axios.post() │       │ fetch + ID/SECRET │       │ 토큰 + 음악 정보 │
└────────────┘◀────└────────────┘◀────└──────────────────────┘
           ▲
           └── 받은 토큰으로 음악 데이터 불러오기!
```




